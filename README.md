# SPARQL updater
Software to automatically fill a Virtuoso DB with Europeana datasets from the Europeana FTP server and update the data
sets regularly.

# Steps to build and start a Virtuoso Docker image locally
1. Check if the Virtuoso buffer settings in the `/virtuoso/Dockerfile_k8s` are appropriate for the server where this is running
   (see also [Virtuoso performance tuning tutorial](https://vos.openlinksw.com/owiki/wiki/VOS/VirtRDFPerformanceTuning#General%20Memory%20Usage%20Settings)
2. Go to folder `virtuoso` and run `docker build -t europeana/sparql-virtuoso -f Dockerfile_k8s .` This will create a 
   Docker image for Virtuoso with relevant settings.
3. Adjust the image name in the file `virtuoso/docker-compose-localtest.yml` and use that to start the container. The 
   Virtuoso GUI will be available at http://localhost:8890/

# Steps to build and start a Virtuoso Docker image including the sparql-updater locally
1. Check if the configuration in the file `/src/main/resources/sparql-updater.user.properties` is present and values are correct
2. Run `mvn clean package` to create the file `/target/sparql-updater.jar`.
   This file contains the code to automatically load sets from the Europeana FTP server and write it to Virtuoso.
3. Go the root project folder and run `docker build -t europeana/sparql-virtuoso-updater -f Dockerfile_updater .`. This 
   will create a Docker image containing both Virtuoso and the built sparql-updater.jar. The jar file will contain the 
   sparql-updater.user.properties file, so don't push this to DockerHub!
4. Check if the settings in the file `virtuoso/docker-compose-updater.yml` are correct and use that to start the
   container.

Some things to be aware of:
* Loading all Europeana datasets in Virtuoso will require around 150GB of disk space!
* For local testing purposes we use a hard-coded password (see `DBA_PASSWORD` variable in `docker-compose-localtest.yml` file.
  For production purposes the credentials in this .yml file and in the user.properties file should be changed.
* After startup a folder named `/database` is automatically created relative to the startup location. This folder contains
  the Virtuoso database files but also has a folder named `tmp-ingest` where files will be stored that are downloaded from
  the ftp-server and generated by the sparql-updater for ingestion. These files are automatically deleted when they are 
  no longer needed.
* You can check which datasets are loaded using this SPARQL query: `SELECT DISTINCT ?g WHERE { GRAPH ?g {?s a ?o} }`
* You can use the `DELETE_VIRTUOSO_DB=true` environment variable to clear the Virtuoso database on startup.

If you are making (configuration) changes to the sparql-updater don't forget to:
 1. Rebuild the jar
 2. Rebuild the Docker image
 3. Recreate the container

